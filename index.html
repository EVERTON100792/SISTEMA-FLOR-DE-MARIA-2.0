<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SGI - Flor de Maria | Sistema de Gestão Integrado</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* SGI - FLOR DE MARIA v9.2 - IMPLEMENTAÇÃO DE LOGO */
        :root {
            --primary-bg: #0B1120;
            --secondary-bg: #131a2b;
            --surface-bg: #1e293b;
            --primary-color: #3b82f6;
            --primary-color-rgb: 59, 130, 246;
            --accent-color: #10b981;
            --danger-color: #ef4444;
            --danger-color-rgb: 239, 68, 68;
            --warning-color: #f59e0b;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
            --border-color: rgba(148, 163, 184, 0.2);
            --hover-bg: #334155;
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', 'Roboto', sans-serif; background-color: var(--primary-bg); color: var(--text-primary); line-height: 1.6; }
        
        .hidden { display: none !important; }

        #loginScreen, #appLayout, #loadingOverlay { display: none; }
        body.state-login #loginScreen { display: flex; }
        body.state-loading #loadingOverlay { display: flex; }
        body.state-app #appLayout { display: flex; }

        .login-container { align-items: center; justify-content: center; min-height: 100vh; padding: 20px; }
        .login-card { background: var(--secondary-bg); padding: 40px; border-radius: 16px; box-shadow: var(--shadow-lg); border: 1px solid var(--border-color); width: 100%; max-width: 400px; text-align: center; }
        
        /* NOVO ESTILO: Logo na tela de login */
        .login-logo img {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            margin-bottom: 16px;
            object-fit: cover;
            border: 2px solid var(--border-color);
        }
        
        .login-title { font-size: 28px; margin-bottom: 8px; }
        .login-subtitle { color: var(--text-muted); margin-bottom: 32px; }
        .input-group { position: relative; margin-bottom: 32px; }
        .form-input, .form-select, .form-textarea {
            width: 100%; padding: 12px 16px; border: 1px solid var(--border-color); border-radius: 8px;
            background: rgba(15, 23, 42, 0.5); color: var(--text-primary); font-size: 15px; transition: var(--transition);
        }
        .form-textarea { resize: vertical; min-height: 80px; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(var(--primary-color-rgb), 0.3); }
        .form-label-float { position: absolute; top: 13px; left: 16px; color: var(--text-muted); pointer-events: none; transition: all 0.2s ease-out; background-color: transparent; padding: 0 4px; }
        .form-input:focus+.form-label-float, .form-input:not(:placeholder-shown)+.form-label-float { top: -10px; font-size: 12px; color: var(--primary-color); background-color: var(--secondary-bg); }

        .app-layout { min-height: 100vh; }
        .sidebar { width: 260px; background: var(--secondary-bg); border-right: 1px solid var(--border-color); padding: 24px 0; position: fixed; top: 0; left: 0; height: 100vh; z-index: 1000; transition: transform 0.3s ease-in-out; }
        .sidebar-header { padding: 0 24px 24px; border-bottom: 1px solid var(--border-color); margin-bottom: 16px; }
        .sidebar-logo { display: flex; align-items: center; gap: 12px; font-size: 20px; font-weight: 700; }
        
        /* NOVO ESTILO: Logo na barra lateral */
        .sidebar-logo img {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
        }

        .sidebar-nav { list-style: none; }
        .sidebar-nav-link { display: flex; align-items: center; gap: 16px; padding: 12px 24px; color: var(--text-muted); text-decoration: none; transition: var(--transition); border-radius: 8px; margin: 4px 12px; }
        .sidebar-nav-link:hover { background: var(--hover-bg); color: var(--text-primary); }
        .sidebar-nav-link.active { background: var(--primary-color); color: var(--text-primary); font-weight: 600; }
        .sidebar-nav-link i { width: 20px; text-align: center; }
        .main-content { flex: 1; margin-left: 260px; padding: 32px; transition: margin-left 0.3s ease-in-out; }
        .page { animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .page-header { margin-bottom: 32px; }
        .page-title { font-size: 32px; font-weight: 700; margin-bottom: 8px; }
        .page-subtitle { color: var(--text-muted); }

        .mobile-menu-toggle { display: none; }

        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 10px 20px; border: 1px solid transparent; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: var(--transition); text-decoration: none; }
        .btn.disabled, .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn:hover:not(:disabled):not(.disabled) { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
        .btn-primary { background: var(--primary-color); color: var(--text-primary); }
        .btn-secondary { background: var(--surface-bg); color: var(--text-primary); border-color: var(--border-color); }
        .btn-danger { background: var(--danger-color); color: var(--text-primary); }
        .btn-accent { background: var(--accent-color); color: var(--text-primary); }
        .btn-sm { padding: 8px 16px; font-size: 12px; }
        
        .card { background: var(--surface-bg); border-radius: 12px; padding: 24px; border: 1px solid var(--border-color); display: flex; flex-direction: column; }
        .card-danger { border-color: rgba(var(--danger-color-rgb), 0.5); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid var(--border-color); }
        .card-title { font-size: 18px; font-weight: 700; }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-secondary); }

        .stats-grid { display: grid; gap: 24px; grid-template-columns: repeat(4, 1fr); }
        .stat-card { background-color: var(--surface-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 24px; position: relative; overflow: hidden; }
        .stat-value { font-size: 28px; font-weight: 700; color: var(--text-primary); margin-bottom: 8px; }
        .stat-label { font-size: 14px; color: var(--text-muted); }
        .stat-icon { position: absolute; right: 20px; top: 50%; transform: translateY(-50%); font-size: 40px; opacity: 0.15; color: var(--text-secondary); }

        .table-responsive { width: 100%; overflow-x: auto; }
        .table { width: 100%; border-collapse: collapse; }
        .table th, .table td { padding: 14px 16px; text-align: left; border-bottom: 1px solid var(--border-color); white-space: nowrap; }
        .table th { font-weight: 600; color: var(--text-secondary); font-size: 12px; text-transform: uppercase; }
        .table tbody tr:hover { background-color: var(--hover-bg); }
        .table-actions { display: flex; gap: 8px; }
        .badge { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .badge-success { background: rgba(16, 185, 129, 0.2); color: var(--accent-color); }
        .badge-danger { background: rgba(239, 68, 68, 0.2); color: var(--danger-color); }
        .badge-warning { background: rgba(245, 158, 11, 0.2); color: var(--warning-color); }
        .badge-info { background: rgba(59, 130, 246, 0.2); color: var(--primary-color); }

        .loading-overlay { flex-direction: column; align-items: center; justify-content: center; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--primary-bg); z-index: 9999; }
        .loading-spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top: 4px solid var(--primary-color); width: 50px; height: 50px; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .notification { position: fixed; top: 20px; right: 20px; padding: 16px 24px; border-radius: 8px; color: var(--text-primary); font-weight: 600; z-index: 9999; transform: translateX(120%); transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .notification.show { transform: translateX(0); }
        .notification-success { background: var(--accent-color); }
        .notification-error { background: var(--danger-color); }
        .notification-warning { background: var(--warning-color); }
        
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); display: none; align-items: center; justify-content: center; z-index: 9998; }
        .modal.show { display: flex; animation: fadeIn 0.3s; }
        .modal-content { background: var(--secondary-bg); border-radius: 12px; padding: 24px; max-width: 800px; width: 90%; max-height: 85vh; display: flex; flex-direction: column; }
        #modalBody { overflow-y: auto; padding-right: 10px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .modal-close { background: none; border: none; color: var(--text-muted); font-size: 24px; cursor: pointer; }
        
        .modal-actions {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .grid { display: grid; gap: 24px; }
        .grid-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-3 { grid-template-columns: repeat(3, 1fr); }
        .grid-4 { grid-template-columns: repeat(4, 1fr); }
        .grid-layout-pdv { grid-template-columns: 2fr 1fr; align-items: start; }
        .mt-4 { margin-top: 24px; }
        .mb-2 { margin-bottom: 16px; }
        .text-center { text-align: center; }

        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: var(--secondary-bg); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: var(--hover-bg); border-radius: 10px; border: 2px solid var(--secondary-bg); }
        
        #pdv-product-card {
            height: 75vh;
            max-height: 700px;
        }
        .product-list-pdv {
            flex-grow: 1;
            overflow-y: auto;
            min-height: 0;
            padding-right: 10px;
        }
        .product-item-pdv { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-radius: 8px; cursor: pointer; transition: var(--transition); }
        .product-item-pdv:hover { background-color: var(--hover-bg); }
        .cart-items { max-height: 300px; overflow-y: auto; padding-right: 10px; }
        .cart-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .cart-total { font-size: 24px; font-weight: bold; color: var(--accent-color); }
        
        .pdv-client-group { display: flex; align-items: center; gap: 10px; }
        .pdv-client-group .form-select { flex-grow: 1; }
        #quickAddClientBtn { padding: 8px 12px; }

        .date-filters { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .date-filters .form-input { max-width: 150px; }

        .dashboard-filters { margin-bottom: 1rem; }
        .dashboard-filters .btn { background-color: var(--surface-bg); }
        .dashboard-filters .btn.active { background-color: var(--primary-color); color: var(--text-primary); }

        @media (max-width: 1200px) {
            .grid-4 { grid-template-columns: repeat(2, 1fr) !important; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 900px) {
            #pdv-product-card { height: auto; max-height: 40vh; }
            .modal-actions { flex-direction: column; }
            .modal-actions .btn { width: 100%; }

            .sidebar { transform: translateX(-100%); }
            .sidebar.active { transform: translateX(0); }
            .main-content { margin-left: 0; padding: 80px 15px 20px; }
            .mobile-menu-toggle { display: block; position: fixed; top: 15px; left: 15px; z-index: 1001; background: var(--surface-bg); border: 1px solid var(--border-color); width: 45px; height: 45px; border-radius: 8px; cursor: pointer; color: var(--text-primary); font-size: 18px; }
            .sidebar-overlay { display: block; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 999; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
            .sidebar-overlay.active { opacity: 1; pointer-events: all; }
            .stats-grid, .grid, .grid-2, .grid-3, .grid-4, .grid-layout-pdv { grid-template-columns: 1fr !important; }
            .table thead { display: none; }
            .table tr { display: block; margin-bottom: 1rem; border: 1px solid var(--border-color); border-radius: 8px; padding: 1rem; }
            .table td { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px dashed var(--border-color); text-align: right; white-space: normal; }
            .table tr td:last-child { border-bottom: none; }
            .table td::before { content: attr(data-label); font-weight: bold; text-align: left; padding-right: 1rem; color: var(--text-secondary); white-space: nowrap; }
        }
    </style>
</head>
<body>
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <p>Carregando dados...</p>
    </div>

    <div id="loginScreen" class="login-container">
        <div class="login-card">
            <div class="login-logo">
                <img src="Screenshot_2025-08-14-21-21-09-908_com.instagram.android-edit.jpg" alt="Flor de Maria Logo">
            </div>
            <h1 class="login-title">Flor de Maria</h1>
            <p class="login-subtitle">Sistema de Gestão Integrado</p>
            
            <form id="loginForm">
                <div class="input-group">
                    <input type="email" id="username" class="form-input" placeholder=" " required>
                    <label for="username" class="form-label-float">Email</label>
                </div>
                
                <div class="input-group">
                    <input type="password" id="password" class="form-input" placeholder=" " required>
                    <label for="password" class="form-label-float">Senha</label>
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%;"><i class="fas fa-sign-in-alt"></i> Entrar</button>
            </form>
        </div>
    </div>

    <div id="appLayout" class="app-layout">
        <button class="mobile-menu-toggle" id="mobileMenuToggle"><i class="fas fa-bars"></i></button>
        <div class="sidebar-overlay" id="sidebarOverlay"></div>
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <img src="Screenshot_2025-08-14-21-21-09-908_com.instagram.android-edit.jpg" alt="Flor de Maria Logo">
                    <span>Flor de Maria</span>
                </div>
            </div>
            <ul class="sidebar-nav">
                <li class="sidebar-nav-item"><a href="#dashboard" class="sidebar-nav-link active" data-page="dashboard"><i class="fas fa-chart-line"></i><span>Dashboard</span></a></li>
                <li class="sidebar-nav-item"><a href="#clients" class="sidebar-nav-link" data-page="clients"><i class="fas fa-users"></i><span>Clientes</span></a></li>
                <li class="sidebar-nav-item"><a href="#products" class="sidebar-nav-link" data-page="products"><i class="fas fa-boxes"></i><span>Estoque</span></a></li>
                <li class="sidebar-nav-item"><a href="#sales" class="sidebar-nav-link" data-page="sales"><i class="fas fa-cash-register"></i><span>PDV</span></a></li>
                <li class="sidebar-nav-item"><a href="#receipts" class="sidebar-nav-link" data-page="receipts"><i class="fas fa-receipt"></i><span>Recibos</span></a></li>
                <li class="sidebar-nav-item"><a href="#cashflow" class="sidebar-nav-link" data-page="cashflow"><i class="fas fa-money-bill-wave"></i><span>Fluxo de Caixa</span></a></li>
                <li class="sidebar-nav-item"><a href="#expenses" class="sidebar-nav-link" data-page="expenses"><i class="fas fa-file-invoice-dollar"></i><span>Despesas</span></a></li>
                <li class="sidebar-nav-item"><a href="#receivables" class="sidebar-nav-link" data-page="receivables"><i class="fas fa-calendar-check"></i><span>Contas a Receber</span></a></li>
                <li class="sidebar-nav-item"><a href="#reports" class="sidebar-nav-link" data-page="reports"><i class="fas fa-chart-bar"></i><span>Relatórios</span></a></li>
                <li class="sidebar-nav-item"><a href="#settings" class="sidebar-nav-link" data-page="settings"><i class="fas fa-cog"></i><span>Configurações</span></a></li>
                <li class="sidebar-nav-item" style="margin-top: 24px; border-top: 1px solid var(--border-color); padding-top: 24px;"><a href="#" class="sidebar-nav-link" id="logoutBtn"><i class="fas fa-sign-out-alt"></i><span>Sair</span></a></li>
            </ul>
        </nav>

        <main class="main-content">
            <div id="dashboardPage" class="page">
                <div class="page-header">
                    <h1 class="page-title">Dashboard</h1>
                    <p class="page-subtitle">Visão geral do seu negócio</p>
                </div>
                <div class="dashboard-filters" id="dashboardDateFilters">
                    <button class="btn btn-sm active" data-period="this_month">Este Mês</button>
                    <button class="btn btn-sm" data-period="last_month">Mês Passado</button>
                    <button class="btn btn-sm" data-period="today">Hoje</button>
                </div>
                <div class="stats-grid mt-4">
                    <div class="stat-card">
                        <div class="stat-value" id="cashBalance">R$ 0,00</div>
                        <div class="stat-label">Saldo em Caixa (Período)</div>
                        <i class="fas fa-wallet stat-icon"></i>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalReceivables">R$ 0,00</div>
                        <div class="stat-label">Total a Receber (Geral)</div>
                        <i class="fas fa-clock stat-icon"></i>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="periodExpenses">R$ 0,00</div>
                        <div class="stat-label">Despesas (Período)</div>
                        <i class="fas fa-credit-card stat-icon"></i>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="periodSales">R$ 0,00</div>
                        <div class="stat-label">Vendas (Período)</div>
                        <i class="fas fa-chart-line stat-icon"></i>
                    </div>
                </div>
                <div class="grid grid-2 mt-4">
                    <div class="card">
                        <div class="card-header"><h3 class="card-title"><i class="fas fa-chart-bar"></i> Vendas por Pagamento (Período)</h3></div>
                        <div class="chart-container" style="position: relative; height:350px;"><canvas id="paymentMethodChart"></canvas></div>
                    </div>
                    <div class="card">
                        <div class="card-header"><h3 class="card-title"><i class="fas fa-exclamation-triangle"></i> Contas Vencidas (Geral)</h3></div>
                        <div id="overdueAccounts" class="custom-scrollbar" style="max-height: 350px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>

            <div id="clientsPage" class="page hidden">
                 <div class="page-header">
                    <h1 class="page-title">Clientes</h1>
                    <p class="page-subtitle">Gerencie seus clientes</p>
                </div>
                <div class="grid grid-2">
                    <div class="card">
                        <div class="card-header"><h3 class="card-title"><i class="fas fa-user-plus"></i> Novo Cliente</h3></div>
                        <form id="clientForm">
                            <input type="hidden" id="clientId">
                            <div class="form-group"><label class="form-label" for="clientName">Nome Completo</label><input type="text" id="clientName" class="form-input" required></div>
                            <div class="form-group"><label class="form-label" for="clientPhone">Telefone</label><input type="tel" id="clientPhone" class="form-input" placeholder="(00) 00000-0000"></div>
                            <div style="display: flex; gap: 8px;">
                                <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Salvar Cliente</button>
                                <button type="button" class="btn btn-secondary" id="clearClientForm"><i class="fas fa-times"></i> Limpar</button>
                            </div>
                        </form>
                    </div>
                    <div class="card">
                        <div class="card-header"><h3 class="card-title"><i class="fas fa-search"></i> Buscar Cliente</h3></div>
                        <div class="form-group"><input type="text" id="clientSearch" class="form-input" placeholder="Digite o nome ou telefone"></div>
                        <div style="display:flex; justify-content: space-between; align-items: center;">
                            <span id="clientCount" class="text-muted">0 clientes cadastrados</span>
                            <button class="btn btn-secondary btn-sm" id="exportClients"><i class="fas fa-download"></i> Exportar CSV</button>
                        </div>
                    </div>
                </div>
                <div class="card mt-4">
                    <div class="card-header"><h3 class="card-title"><i class="fas fa-users"></i> Lista de Clientes</h3></div>
                    <div class="table-responsive"><table class="table">
                        <thead><tr><th>Nome</th><th>Telefone</th><th>Cadastro</th><th>Compras</th><th>Total Gasto</th><th>Ações</th></tr></thead>
                        <tbody id="clientsTableBody"></tbody>
                    </table></div>
                </div>
            </div>
            
            <div id="productsPage" class="page hidden">
                <div class="page-header">
                    <h1 class="page-title">Estoque</h1>
                    <p class="page-subtitle">Gerencie seus produtos</p>
                </div>
                <div class="grid grid-2">
                    <div class="card">
                        <div class="card-header"><h3 class="card-title"><i class="fas fa-box"></i> Novo Produto</h3></div>
                        <form id="productForm">
                            <input type="hidden" id="productId">
                            <div class="form-group"><label class="form-label" for="productRefCode">Código de Referência</label><input type="text" id="productRefCode" class="form-input" required></div>
                            <div class="form-group"><label class="form-label" for="productName">Nome do Produto</label><input type="text" id="productName" class="form-input" required></div>
                            <div class="grid grid-3">
                                <div class="form-group"><label class="form-label" for="productQuantity">Quantidade</label><input type="number" id="productQuantity" class="form-input" min="0" required></div>
                                <div class="form-group"><label class="form-label" for="productCostPrice">Preço de Custo</label><input type="number" id="productCostPrice" class="form-input" min="0" step="0.01" required></div>
                                <div class="form-group"><label class="form-label" for="productSalePrice">Preço de Venda</label><input type="number" id="productSalePrice" class="form-input" min="0" step="0.01" required></div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Salvar Produto</button>
                                <button type="button" class="btn btn-secondary" id="clearProductForm"><i class="fas fa-times"></i> Limpar</button>
                            </div>
                        </form>
                    </div>
                    <div class="card">
                        <div class="card-header"><h3 class="card-title"><i class="fas fa-chart-pie"></i> Resumo do Estoque</h3></div>
                        <div class="grid grid-2" style="margin-bottom: 20px;">
                            <div class="text-center"><div class="stat-value" id="totalProducts">0</div><div class="stat-label">Total de Produtos</div></div>
                            <div class="text-center"><div class="stat-value" id="outOfStockProducts">0</div><div class="stat-label">Produtos Esgotados</div></div>
                        </div>
                        <div class="form-group"><input type="text" id="productSearch" class="form-input" placeholder="Buscar produto por nome ou código"></div>
                        <button class="btn btn-secondary btn-sm" id="exportProducts" style="width: 100%;"><i class="fas fa-download"></i> Exportar Estoque (CSV)</button>
                    </div>
                </div>
                <div class="card mt-4">
                    <div class="card-header"><h3 class="card-title"><i class="fas fa-boxes"></i> Lista de Produtos</h3></div>
                    <div class="table-responsive"><table class="table">
                        <thead><tr><th>Código</th><th>Nome</th><th>Qtd.</th><th>P. Custo</th><th>P. Venda</th><th>Margem</th><th>Status</th><th>Ações</th></tr></thead>
                        <tbody id="productsTableBody"></tbody>
                    </table></div>
                </div>
            </div>

            <div id="salesPage" class="page hidden">
                <div class="page-header">
                    <h1 class="page-title">PDV - Ponto de Venda</h1>
                    <p class="page-subtitle">Realize uma nova venda</p>
                </div>
                <div class="grid grid-layout-pdv">
                    <div class="card" id="pdv-product-card">
                        <div class="card-header"><h3 class="card-title"><i class="fas fa-search"></i> Buscar Produtos</h3></div>
                        <div class="form-group" style="margin-bottom: 10px;"><input type="text" id="pdvProductSearch" class="form-input" placeholder="Digite o nome ou código do produto..."></div>
                        <div id="pdvProductList" class="product-list-pdv custom-scrollbar"></div>
                    </div>
                    <div class="card">
                        <div class="card-header"><h3 class="card-title"><i class="fas fa-shopping-cart"></i> Carrinho</h3></div>
                        <div id="pdvCartItems" class="cart-items custom-scrollbar"></div>
                        <hr style="border-color: var(--border-color); margin: 20px 0;">
                        <div class="form-group">
                            <label for="pdvClient" class="form-label">Cliente</label>
                            <div class="pdv-client-group">
                                <select id="pdvClient" class="form-select"></select>
                                <button id="quickAddClientBtn" class="btn btn-secondary" title="Adicionar Novo Cliente"><i class="fas fa-plus"></i></button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="pdvPaymentMethod" class="form-label">Forma de Pagamento</label>
                            <select id="pdvPaymentMethod" class="form-select">
                                <option value="Dinheiro">Dinheiro</option>
                                <option value="Pix">Pix</option>
                                <option value="Cartão de Débito">Cartão de Débito</option>
                                <option value="Cartão de Crédito">Cartão de Crédito</option>
                                <option value="Crediário">Crediário</option>
                                <option value="A Prazo">A Prazo</option>
                            </select>
                        </div>
                         <div id="pdvInstallmentsGroup" class="form-group hidden">
                            <label for="pdvInstallments" class="form-label">Parcelas</label>
                            <select id="pdvInstallments" class="form-select"></select>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span class="text-muted">TOTAL:</span>
                            <div id="pdvTotal" class="cart-total">R$ 0,00</div>
                        </div>
                        <button id="finalizeSaleBtn" class="btn btn-accent" style="width: 100%;"><i class="fas fa-check"></i> Finalizar Venda</button>
                    </div>
                </div>
            </div>

            <div id="receiptsPage" class="page hidden">
                <div class="page-header">
                    <h1 class="page-title">Recibos de Vendas</h1>
                    <p class="page-subtitle">Consulte o histórico de vendas realizadas</p>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-history"></i> Histórico de Vendas</h3>
                    </div>
                    <div class="date-filters">
                        <input type="date" id="receiptsStartDate" class="form-input">
                        <input type="date" id="receiptsEndDate" class="form-input">
                        <button id="receiptsFilterBtn" class="btn btn-primary btn-sm">Filtrar</button>
                        <button id="receiptsClearBtn" class="btn btn-secondary btn-sm">Limpar</button>
                    </div>
                    <div class="table-responsive">
                        <table class="table">
                            <thead><tr><th>Recibo</th><th>Data</th><th>Cliente</th><th>Total</th><th>Pagamento</th><th>Ações</th></tr></thead>
                            <tbody id="receiptsTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="cashflowPage" class="page hidden">
                <div class="page-header">
                    <h1 class="page-title">Fluxo de Caixa</h1>
                    <p class="page-subtitle">Controle as entradas e saídas financeiras</p>
                </div>
                <div class="card">
                     <div class="card-header"><h3 class="card-title"><i class="fas fa-exchange-alt"></i> Lançamentos</h3></div>
                     <div class="date-filters">
                        <input type="date" id="cashflowStartDate" class="form-input">
                        <input type="date" id="cashflowEndDate" class="form-input">
                        <button id="cashflowFilterBtn" class="btn btn-primary btn-sm">Filtrar</button>
                        <button id="cashflowClearBtn" class="btn btn-secondary btn-sm">Limpar</button>
                    </div>
                     <div class="table-responsive">
                        <table class="table">
                            <thead><tr><th>Data</th><th>Descrição</th><th>Tipo</th><th>Valor</th></tr></thead>
                            <tbody id="cashflowTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="expensesPage" class="page hidden">
                 <div class="page-header">
                    <h1 class="page-title">Despesas</h1>
                    <p class="page-subtitle">Gerencie suas despesas e custos</p>
                </div>
                <div class="card">
                    <div class="card-header"><h3 class="card-title"><i class="fas fa-plus-circle"></i> Nova Despesa</h3></div>
                    <form id="expenseForm">
                        <div class="grid grid-3">
                            <div class="form-group"><label for="expenseDescription" class="form-label">Descrição</label><input type="text" id="expenseDescription" class="form-input" required></div>
                            <div class="form-group"><label for="expenseValue" class="form-label">Valor</label><input type="number" id="expenseValue" class="form-input" step="0.01" min="0" required></div>
                            <div class="form-group"><label for="expenseDate" class="form-label">Data</label><input type="date" id="expenseDate" class="form-input" required></div>
                        </div>
                        <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Lançar Despesa</button>
                    </form>
                </div>
                <div class="card mt-4">
                    <div class="card-header"><h3 class="card-title"><i class="fas fa-list-alt"></i> Histórico de Despesas</h3></div>
                     <div class="date-filters">
                        <input type="date" id="expensesStartDate" class="form-input">
                        <input type="date" id="expensesEndDate" class="form-input">
                        <button id="expensesFilterBtn" class="btn btn-primary btn-sm">Filtrar</button>
                        <button id="expensesClearBtn" class="btn btn-secondary btn-sm">Limpar</button>
                    </div>
                     <div class="table-responsive">
                        <table class="table">
                            <thead><tr><th>Data</th><th>Descrição</th><th>Valor</th><th>Ações</th></tr></thead>
                            <tbody id="expensesTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="receivablesPage" class="page hidden">
                <div class="page-header">
                    <h1 class="page-title">Contas a Receber</h1>
                    <p class="page-subtitle">Gerencie os pagamentos pendentes</p>
                </div>
                 <div class="card">
                    <div class="card-header"><h3 class="card-title"><i class="fas fa-tasks"></i> Contas Pendentes e Vencidas</h3></div>
                     <div class="table-responsive">
                        <table class="table">
                            <thead><tr><th>Cliente</th><th>Valor</th><th>Data Venda</th><th>Vencimento</th><th>Status</th><th>Ações</th></tr></thead>
                            <tbody id="receivablesTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="reportsPage" class="page hidden">
                <div class="page-header">
                    <h1 class="page-title">Relatórios</h1>
                    <p class="page-subtitle">Gere relatórios para análise do seu negócio</p>
                </div>
                <div class="grid grid-4">
                    <div class="card">
                        <div class="card-header"><h3 class="card-title"><i class="fas fa-file-invoice-dollar"></i> Relatório de Vendas</h3></div>
                        <p class="text-muted" style="margin-bottom: 20px;">Gere um relatório de vendas por período.</p>
                        <button class="btn btn-primary" id="generateSalesReportBtn"><i class="fas fa-cogs"></i> Gerar Relatório</button>
                    </div>
                    <div class="card">
                        <div class="card-header"><h3 class="card-title"><i class="fas fa-star"></i> Produtos Mais Vendidos</h3></div>
                        <p class="text-muted" style="margin-bottom: 20px;">Veja um ranking dos produtos mais vendidos.</p>
                        <button class="btn btn-primary" id="generateTopProductsReportBtn"><i class="fas fa-cogs"></i> Gerar Relatório</button>
                    </div>
                     <div class="card">
                        <div class="card-header"><h3 class="card-title"><i class="fas fa-user-tag"></i> Compras por Cliente</h3></div>
                        <p class="text-muted" style="margin-bottom: 20px;">Relatório de compras detalhado por cliente.</p>
                        <button class="btn btn-primary" id="generateClientSalesReportBtn"><i class="fas fa-cogs"></i> Gerar Relatório</button>
                    </div>
                    <div class="card">
                        <div class="card-header"><h3 class="card-title"><i class="fas fa-user-check"></i> Análise de Cliente</h3></div>
                        <p class="text-muted" style="margin-bottom: 20px;">Verificar contas pagas e pendentes por cliente.</p>
                        <button class="btn btn-primary" id="generateClientReceivablesReportBtn"><i class="fas fa-cogs"></i> Gerar Relatório</button>
                    </div>
                </div>
                 <div class="card mt-4">
                    <div class="card-header" id="reportOutputHeader"><h3 class="card-title"><i class="fas fa-chart-pie"></i> Visualização de Relatório</h3></div>
                    <div id="reportOutput" class="text-center" style="min-height: 200px; padding: 20px; color: var(--text-muted);">
                        Selecione um relatório para visualizar os dados aqui.
                    </div>
                </div>
            </div>

            <div id="settingsPage" class="page hidden">
                <div class="page-header">
                    <h1 class="page-title">Configurações</h1>
                    <p class="page-subtitle">Ajuste as informações da sua empresa</p>
                </div>
                <div class="card">
                     <div class="card-header"><h3 class="card-title"><i class="fas fa-building"></i> Dados da Empresa</h3></div>
                     <form id="settingsForm">
                        <div class="grid grid-2">
                            <div class="form-group"><label for="companyName" class="form-label">Nome da Empresa</label><input type="text" id="companyName" class="form-input"></div>
                            <div class="form-group"><label for="companyCnpj" class="form-label">CNPJ</label><input type="text" id="companyCnpj" class="form-input"></div>
                        </div>
                        <div class="form-group"><label for="companyAddress" class="form-label">Endereço</label><input type="text" id="companyAddress" class="form-input"></div>
                        <div class="form-group"><label for="companyPhone" class="form-label">Telefone</label><input type="text" id="companyPhone" class="form-input"></div>
                        <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Salvar Configurações</button>
                     </form>
                </div>

                <div class="card card-danger mt-4">
                    <div class="card-header"><h3 class="card-title" style="color: var(--danger-color);"><i class="fas fa-exclamation-triangle"></i> Zona de Perigo</h3></div>
                    <div class="danger-zone-content">
                        <div class="mb-2" style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border-color);">
                            <div>
                                <strong>Zerar Lançamentos Financeiros</strong>
                                <p class="text-muted" style="font-size: 14px;">Apaga todas as vendas, despesas, contas a receber e fluxo de caixa. Clientes e produtos não são afetados. Ideal para testes.</p>
                            </div>
                            <button id="resetFinancialDataBtn" class="btn btn-danger"><i class="fas fa-bomb"></i> Zerar Dados</button>
                        </div>
                         <div class="mb-2" style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border-color);">
                            <div>
                                <strong>Limpar Base de Clientes</strong>
                                <p class="text-muted" style="font-size: 14px;">Apaga permanentemente todos os clientes cadastrados e seus respectivos históricos de vendas.</p>
                            </div>
                            <button id="clearClientsBtn" class="btn btn-danger"><i class="fas fa-users-slash"></i> Limpar Clientes</button>
                        </div>
                         <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0;">
                            <div>
                                <strong>Limpar Estoque de Produtos</strong>
                                <p class="text-muted" style="font-size: 14px;">Apaga permanentemente todos os produtos do estoque. Isso pode afetar o histórico de vendas.</p>
                            </div>
                            <button id="clearProductsBtn" class="btn btn-danger"><i class="fas fa-boxes"></i> Limpar Produtos</button>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <div id="notification" class="notification"><span id="notificationText"></span></div>
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Modal</h3>
                <button class="modal-close" id="modalClose"><i class="fas fa-times"></i></button>
            </div>
            <div id="modalBody" class="custom-scrollbar"></div>
        </div>
    </div>

    <script>
    // ===== SGI - FLOR DE MARIA v9.2 - IMPLEMENTAÇÃO DE LOGO =====
    
    const SUPABASE_URL = 'https://pjbmcwefqsfqnlfvledz.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBqYm1jd2VmcXNmcW5sZnZsZWR6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxMzUwMTIsImV4cCI6MjA3MDcxMTAxMn0.f1V4yZ01eOt_ols8Cg5ATvtvz-GEomU6K6SzHg8kKIQ';
    
    const { createClient } = supabase;
    const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    const CONFIG = {
        storageKeys: { 
            lastActivePage: 'sgi_last_active_page',
            companyInfo: 'sgi_company_info'
        },
        company: { 
            name: 'Flor de Maria', 
            address: 'Rua das Flores, 123 - Centro', 
            phone: '(11) 98765-4321', 
            cnpj: '12.345.678/0001-99' 
        }
    };
    
    const state = {
        clients: [], products: [], sales: [], cashFlow: [], expenses: [], receivables: [],
        cart: [], currentEditId: null, chartInstances: {}
    };
    
    const Utils = {
        formatCurrency: v => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(Number(v) || 0),
        formatDate: d => d ? new Date(d).toLocaleDateString('pt-BR', { timeZone: 'UTC' }) : 'N/A',
        formatInputDate: d => d ? new Date(d).toISOString().split('T')[0] : '',
        formatShortId: id => id ? id.toString().slice(-6).toUpperCase() : 'N/A',
        debounce: (func, delay = 300) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => func.apply(this, a), delay); }; },
        populateSelect: (id, data, valF, textF, defTxt) => {
            const s = document.getElementById(id);
            if (!s) return;
            s.innerHTML = `<option value="">${defTxt}</option>`;
            [...data].sort((a, b) => (a[textF] || '').localeCompare(b[textF] || '')).forEach(i => {
                s.innerHTML += `<option value="${i[valF]}">${i[textF]}</option>`;
            });
        },
        exportToCSV: (filename, data) => {
            if (!data || data.length === 0) return Notification.warning("Não há dados para exportar.");
            const headers = Object.keys(data[0]);
            const csv = [
                headers.join(','),
                ...data.map(row => headers.map(h => `"${(row[h] ?? '').toString().replace(/"/g, '""')}"`).join(','))
            ].join('\n');
            const blob = new Blob([`\uFEFF${csv}`], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
            URL.revokeObjectURL(link.href);
            Notification.success("Dados exportados com sucesso!");
        },
        exportToPDF: (title, head, body, extraContent = null) => {
            if (!body || body.length === 0) return Notification.warning("Não há dados para gerar PDF.");
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text(title, 14, 16);
            if(extraContent) {
                let yPos = 22;
                extraContent.forEach(line => {
                    doc.setFontSize(10);
                    doc.text(line, 14, yPos);
                    yPos += 6;
                });
            }
            const startY = extraContent ? extraContent.length * 6 + 25 : 25;
            doc.autoTable({ head, body, startY: startY, theme: 'grid', headStyles: { fillColor: [59, 130, 246] } });
            doc.save(`${title.replace(/\s+/g, '_').toLowerCase()}.pdf`);
            Notification.success("PDF gerado com sucesso!");
        },
        renderChart(id, type, data, options) {
            if (state.chartInstances[id]) state.chartInstances[id].destroy();
            const ctx = document.getElementById(id)?.getContext('2d');
            if (ctx) state.chartInstances[id] = new Chart(ctx, { type, data, options });
        }
    };
    
    const Notification = {
        show: (msg, type = 'success') => {
            const el = document.getElementById('notification');
            const textEl = document.getElementById('notificationText');
            if(el && textEl) {
                textEl.textContent = msg;
                el.className = `notification notification-${type} show`;
                setTimeout(() => el.classList.remove('show'), 4000);
            }
        },
        success: m => Notification.show(m, 'success'),
        error: m => Notification.show(m, 'error'),
        warning: m => Notification.show(m, 'warning'),
    };
    
    const Modal = {
        show: (title, content) => {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').innerHTML = content;
            document.getElementById('modal').classList.add('show');
        },
        hide: () => document.getElementById('modal').classList.remove('show')
    };
    
    const App = {
        modules: {},
        async init() {
            Object.values(this.modules).forEach(m => m.init?.());
            document.getElementById('modalClose').addEventListener('click', Modal.hide);
            
            db.auth.onAuthStateChange((event, session) => {
                if (session) Auth.showApp();
                else Auth.showLogin();
            });

            const { data: { session } } = await db.auth.getSession();
            if (session) await Auth.showApp();
            else Auth.showLogin();
            console.log('SGI - Flor de Maria v9.2 (Bug Fixes) Iniciado.');
        },
        async loadAllData(showLoading = true) {
            if(showLoading) document.body.className = 'state-loading';
            const tables = [
                'clients', 'products', 'sales', 
                'cash_flow', 'expenses', 'receivables'
            ];
            const promises = tables.map(t => db.from(t).select('*'));
            const results = await Promise.allSettled(promises);
            
            results.forEach((res, i) => {
                const tableName = tables[i];
                const stateTableName = tableName.replace(/_([a-z])/g, g => g[1].toUpperCase());
                
                if (res.status === 'fulfilled' && !res.value.error) {
                    state[stateTableName] = res.value.data;
                } else {
                    console.error(`Falha ao carregar ${tableName}:`, res.value ? res.value.error : res.reason);
                    Notification.error(`Falha ao carregar ${tableName}.`);
                    state[stateTableName] = [];
                }
            });
            App.modules.Settings.loadCompanyInfo();
            if(showLoading) document.body.className = 'state-app';
        }
    };
    
    const Auth = {
        init() {
            document.getElementById('loginForm').addEventListener('submit', this.handleLogin);
            document.getElementById('logoutBtn').addEventListener('click', this.handleLogout);
        },
        async handleLogin(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Entrando...';
            const { error } = await db.auth.signInWithPassword({
                email: e.target.username.value,
                password: e.target.password.value
            });
            if (error) {
                Notification.error('Email ou senha inválidos.');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Entrar';
            }
        },
        async handleLogout() {
            await db.auth.signOut();
        },
        showLogin() {
        document.body.className = 'state-login';

        // --- INÍCIO DA CORREÇÃO ---
        const loginForm = document.getElementById('loginForm');
        if (loginForm) {
            loginForm.reset(); // Reseta os campos de email e senha
            const btn = loginForm.querySelector('button');
            if (btn) {
                btn.disabled = false; // Reabilita o botão
                btn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Entrar'; // Restaura o texto original do botão
            }
        }
        },
        async showApp() {
            await App.loadAllData();
            const lastPage = localStorage.getItem(CONFIG.storageKeys.lastActivePage) || 'dashboard';
            await Navigation.navigateTo(lastPage, false);
        }
    };
    App.modules.Auth = Auth;
    
    const Navigation = {
        init() {
            const sidebar = document.getElementById('sidebar'), overlay = document.getElementById('sidebarOverlay');
            document.querySelectorAll('.sidebar-nav-link').forEach(link => {
                if (link.id !== 'logoutBtn') {
                    link.addEventListener('click', e => {
                        e.preventDefault();
                        this.navigateTo(link.dataset.page);
                        sidebar.classList.remove('active');
                        overlay.classList.remove('active');
                    });
                }
            });
            const toggle = () => { sidebar.classList.toggle('active'); overlay.classList.toggle('active'); };
            document.getElementById('mobileMenuToggle').addEventListener('click', toggle);
            overlay.addEventListener('click', toggle);
        },
        async navigateTo(page, reloadData = true) {
            if(reloadData) await App.loadAllData(false);

            document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
            const targetPage = document.getElementById(`${page}Page`);
            if (targetPage) targetPage.classList.remove('hidden');
            else { page = 'dashboard'; document.getElementById('dashboardPage').classList.remove('hidden'); }
            
            document.querySelectorAll('.sidebar-nav-link').forEach(l => l.classList.remove('active'));
            document.querySelector(`[data-page="${page}"]`)?.classList.add('active');
            localStorage.setItem(CONFIG.storageKeys.lastActivePage, page);

            const activeModule = Object.values(App.modules).find(m => m.pageId === page);
            if (activeModule && activeModule.load) await activeModule.load();
        }
    };
    App.modules.Navigation = Navigation;
    
    App.modules.Dashboard = {
        pageId: 'dashboard',
        init() {
            document.getElementById('dashboardDateFilters').addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    document.querySelectorAll('#dashboardDateFilters .btn').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    this.updateDashboardForPeriod(e.target.dataset.period);
                }
            });
        },
        load() {
            document.querySelector('#dashboardDateFilters .btn.active')?.classList.remove('active');
            document.querySelector('#dashboardDateFilters .btn[data-period="this_month"]').classList.add('active');
            this.updateDashboardForPeriod('this_month');
        },
        updateDashboardForPeriod(period) {
            const now = new Date();
            let startDate, endDate = new Date();

            switch(period) {
                case 'today':
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0, 0);
                    endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);
                    break;
                case 'last_month':
                    startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    endDate = new Date(now.getFullYear(), now.getMonth(), 0, 23, 59, 59, 999);
                    break;
                case 'this_month':
                default:
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);
                    break;
            }
            this.updateStats(startDate, endDate);
            this.renderPaymentMethodChart(startDate, endDate);
            this.renderOverdueAccounts();
        },
        updateStats(startDate, endDate) {
            const { cashFlow, receivables, sales, expenses } = state;
            
            const salesInPeriod = sales.filter(s => new Date(s.date) >= startDate && new Date(s.date) <= endDate);
            const expensesInPeriod = expenses.filter(e => { const d = new Date(e.date); return d >= startDate && d <= endDate; });
            const cashFlowInPeriod = cashFlow.filter(cf => { const d = new Date(cf.date); return d >= startDate && d <= endDate; });

            const periodSales = salesInPeriod.reduce((a, s) => a + s.total, 0);
            const periodExpenses = expensesInPeriod.reduce((a, e) => a + e.value, 0);
            const cashBalance = cashFlowInPeriod.reduce((a, t) => a + (t.type === 'entrada' ? 1 : -1) * t.value, 0);
            const totalReceivables = receivables.filter(r => r.status !== 'Pago').reduce((a, r) => a + r.value, 0);
            
            document.getElementById('periodSales').textContent = Utils.formatCurrency(periodSales);
            document.getElementById('periodExpenses').textContent = Utils.formatCurrency(periodExpenses);
            document.getElementById('cashBalance').textContent = Utils.formatCurrency(cashBalance);
            document.getElementById('totalReceivables').textContent = Utils.formatCurrency(totalReceivables);
        },
        renderPaymentMethodChart(startDate, endDate) {
            const salesInPeriod = state.sales.filter(s => new Date(s.date) >= startDate && new Date(s.date) <= endDate);

            const dataByMethod = salesInPeriod.reduce((acc, sale) => {
                const method = sale.payment_method.split(' (')[0];
                acc[method] = (acc[method] || 0) + sale.total;
                return acc;
            }, {});

            const labels = Object.keys(dataByMethod);
            const data = Object.values(dataByMethod);

            Utils.renderChart('paymentMethodChart', 'bar', { labels, datasets: [{ data, backgroundColor: ['#3b82f6', '#10b981', '#ef4444', '#f59e0b', '#8b5cf6', '#64748b'] }] }, 
                { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: false } },
                scales: { x: { ticks: { color: 'var(--text-secondary)' }, grid: { color: 'var(--border-color)' } }, y: { ticks: { color: 'var(--text-secondary)' }, grid: { color: 'transparent' } } }
            });
        },
        renderOverdueAccounts() {
            const today = new Date().toISOString().split('T')[0];
            const overdue = state.receivables.filter(r => r.status === 'Pendente' && r.due_date < today);
            const container = document.getElementById('overdueAccounts');
            if (overdue.length === 0) {
                container.innerHTML = `<p class="text-center" style="color: var(--text-muted); padding: 20px;">Nenhuma conta vencida. ✅</p>`;
                return;
            }
            container.innerHTML = overdue.map(r => {
                const client = state.clients.find(c => c.id === r.client_id)?.name || 'Cliente não encontrado';
                return `<div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid var(--border-color);">
                            <div><p style="font-weight: bold;">${client}</p><p style="font-size: 12px; color: var(--text-muted);">Venceu em: ${Utils.formatDate(r.due_date)}</p></div>
                            <strong style="color: var(--danger-color);">${Utils.formatCurrency(r.value)}</strong>
                        </div>`;
            }).join('');
        }
    };
    
    const createCrudModule = (config) => ({
        pageId: config.pageId,
        init() {
            document.getElementById(config.formId).addEventListener('submit', this.save.bind(this));
            if (config.searchId) document.getElementById(config.searchId).addEventListener('input', Utils.debounce(() => this.render(), 300));
            if (config.clearBtnId) document.getElementById(config.clearBtnId).addEventListener('click', () => this.clearForm());
            if (config.exportBtnId) document.getElementById(config.exportBtnId).addEventListener('click', this.export.bind(this));
        },
        load() { this.render(); if (this.updateStats) this.updateStats(); this.clearForm(); },
        getFiltered() {
            if (!config.searchId) return state[config.stateKey];
            const query = document.getElementById(config.searchId).value.toLowerCase();
            return query ? state[config.stateKey].filter(item => config.filterKeys.some(key => (item[key] || '').toString().toLowerCase().includes(query))) : state[config.stateKey];
        },
        render() {
            const data = this.getFiltered().sort((a,b) => new Date(b.created_at) - new Date(a.created_at));
            if (config.countId) document.getElementById(config.countId).textContent = `${data.length} item(s)`;
            const body = document.getElementById(config.tableBodyId);
            if(body) body.innerHTML = data.length > 0 ? data.map(item => config.renderRow(item, state)).join('') : config.emptyRow;
            if(this.updateStats) this.updateStats();
        },
        async save(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            btn.disabled = true;

            const itemData = config.getFormData(e.target);
            if (config.validate && !config.validate(itemData, state)) {
                btn.disabled = false;
                return;
            }
            if (config.beforeSaveValidation) {
                const validationError = config.beforeSaveValidation(itemData, state);
                if (validationError) {
                    Notification.error(validationError);
                    btn.disabled = false;
                    return;
                }
            }
            
            try {
                const { data, error } = await (state.currentEditId
                    ? db.from(config.tableName).update(itemData).eq('id', state.currentEditId)
                    : db.from(config.tableName).insert(itemData)
                ).select().single();
                if (error) throw error;
                
                await App.loadAllData(false);
                
                Notification.success(`${config.name} ${state.currentEditId ? 'atualizado' : 'salvo'}!`);
                this.clearForm();
                this.render();
                if(config.onSave) config.onSave(data);

            } catch (error) { Notification.error(`Erro ao salvar: ${error.message}`); }
            finally { btn.disabled = false; }
        },
        edit(id) {
            const item = state[config.stateKey].find(i => i.id === id);
            if (!item) return;
            state.currentEditId = id;
            config.populateForm(item);
            document.querySelector(`#${config.formId} button[type="submit"]`).innerHTML = `<i class="fas fa-save"></i> Atualizar`;
            document.getElementById(config.focusFieldId).focus();
        },
        async remove(id) {
            if (!confirm(`Deseja realmente excluir este ${config.name}?`)) return;
            try {
                const { error } = await db.from(config.tableName).delete().eq('id', id);
                if (error) throw error;
                
                await App.loadAllData(false);
                this.render();
                if(config.onRemove) config.onRemove();

            } catch (error) { 
                console.error(`Erro detalhado ao excluir ${config.name}:`, error);
                Notification.error(`Erro ao excluir: ${error.message}`);
            }
        },
        clearForm() {
            state.currentEditId = null;
            document.getElementById(config.formId).reset();
            document.querySelector(`#${config.formId} button[type="submit"]`).innerHTML = `<i class="fas fa-save"></i> Salvar`;
        },
        export() {
            Utils.exportToCSV(`${config.tableName}.csv`, this.getFiltered().map(item => config.mapExport(item, state)));
        }
    });

    App.modules.Clients = { ...createCrudModule({
        pageId: 'clients', name: 'Cliente', stateKey: 'clients', tableName: 'clients', formId: 'clientForm', tableBodyId: 'clientsTableBody',
        searchId: 'clientSearch', clearBtnId: 'clearClientForm', exportBtnId: 'exportClients', countId: 'clientCount', focusFieldId: 'clientName',
        filterKeys: ['name', 'phone'],
        getFormData: f => ({ name: f.clientName.value.trim(), phone: f.clientPhone.value.trim() }),
        validate: d => d.name ? true : (Notification.error('O nome é obrigatório.'), false),
        populateForm: c => {
            document.getElementById('clientName').value = c.name;
            document.getElementById('clientPhone').value = c.phone || '';
        },
        renderRow: (c, s) => {
            const totalSpent = s.sales.filter(sl => sl.client_id === c.id).reduce((sum, sale) => sum + sale.total, 0);
            return `<tr>
                <td data-label="Nome">${c.name}</td>
                <td data-label="Telefone">${c.phone || 'N/A'}</td>
                <td data-label="Cadastro">${Utils.formatDate(c.created_at)}</td>
                <td data-label="Compras">${s.sales.filter(sl => sl.client_id === c.id).length}</td>
                <td data-label="Total Gasto">${Utils.formatCurrency(totalSpent)}</td>
                <td data-label="Ações"><div class="table-actions">
                    <button class="btn btn-secondary btn-sm" onclick="App.modules.Clients.edit('${c.id}')"><i class="fas fa-edit"></i></button>
                    <button class="btn btn-danger btn-sm" onclick="App.modules.Clients.remove('${c.id}')"><i class="fas fa-trash"></i></button>
                </div></td>
            </tr>`;
        },
        emptyRow: `<tr><td colspan="6" class="text-center" style="padding: 20px;">Nenhum cliente encontrado.</td></tr>`,
        mapExport: (c, s) => {
            const totalSpent = s.sales.filter(sl => sl.client_id === c.id).reduce((sum, sale) => sum + sale.total, 0);
            return { id: c.id, nome: c.name, telefone: c.phone, data_cadastro: Utils.formatDate(c.created_at), total_gasto: totalSpent };
        }
    })};
    
    App.modules.Products = { ...createCrudModule({
        pageId: 'products', name: 'Produto', stateKey: 'products', tableName: 'products', formId: 'productForm', tableBodyId: 'productsTableBody',
        searchId: 'productSearch', clearBtnId: 'clearProductForm', exportBtnId: 'exportProducts', focusFieldId: 'productRefCode',
        filterKeys: ['name', 'ref_code'],
        getFormData: f => ({ ref_code: f.productRefCode.value.trim(), name: f.productName.value.trim(), quantity: parseInt(f.productQuantity.value), cost_price: parseFloat(f.productCostPrice.value), sale_price: parseFloat(f.productSalePrice.value) }),
        validate: d => (d.ref_code && d.name && !isNaN(d.quantity) && !isNaN(d.cost_price) && !isNaN(d.sale_price)) ? true : (Notification.error('Preencha todos os campos corretamente.'), false),
        beforeSaveValidation: (itemData, s) => {
            const codeExists = s.products.some(p => p.ref_code.toLowerCase() === itemData.ref_code.toLowerCase() && p.id !== s.currentEditId);
            if (codeExists) {
                return "Já existe um produto com este Código de Referência.";
            }
            return null;
        },
        populateForm: p => {
            document.getElementById('productRefCode').value = p.ref_code;
            document.getElementById('productName').value = p.name;
            document.getElementById('productQuantity').value = p.quantity;
            document.getElementById('productCostPrice').value = p.cost_price;
            document.getElementById('productSalePrice').value = p.sale_price;
        },
        renderRow: p => {
            const margin = p.cost_price > 0 && p.sale_price > 0 ? (((p.sale_price - p.cost_price) / p.sale_price) * 100).toFixed(2) + '%' : 'N/A';
            const status = p.quantity > 5 ? `<span class="badge badge-success">Em Estoque</span>` : (p.quantity > 0 ? `<span class="badge badge-warning">Estoque Baixo</span>` : `<span class="badge badge-danger">Esgotado</span>`);
            return `<tr>
                <td data-label="Código">${p.ref_code}</td><td data-label="Nome">${p.name}</td><td data-label="Qtd.">${p.quantity}</td>
                <td data-label="P. Custo">${Utils.formatCurrency(p.cost_price)}</td><td data-label="P. Venda">${Utils.formatCurrency(p.sale_price)}</td>
                <td data-label="Margem">${margin}</td><td data-label="Status">${status}</td>
                <td data-label="Ações"><div class="table-actions">
                    <button class="btn btn-secondary btn-sm" onclick="App.modules.Products.edit('${p.id}')"><i class="fas fa-edit"></i></button>
                    <button class="btn btn-danger btn-sm" onclick="App.modules.Products.remove('${p.id}')"><i class="fas fa-trash"></i></button>
                </div></td>
            </tr>`;
        },
        emptyRow: `<tr><td colspan="8" class="text-center" style="padding:20px;">Nenhum produto encontrado.</td></tr>`,
        mapExport: p => ({ codigo: p.ref_code, nome: p.name, quantidade: p.quantity, preco_custo: p.cost_price, preco_venda: p.sale_price }),
        updateStats() {
            document.getElementById('totalProducts').textContent = state.products.length;
            document.getElementById('outOfStockProducts').textContent = state.products.filter(p => p.quantity <= 0).length;
        }
    })};
    
    App.modules.Sales = {
        pageId: 'sales',
        init() {
            document.getElementById('pdvProductSearch').addEventListener('input', Utils.debounce(() => this.renderProductList(), 300));
            document.getElementById('finalizeSaleBtn').addEventListener('click', this.finalizeSale.bind(this));
            document.getElementById('pdvPaymentMethod').addEventListener('change', this.toggleInstallmentsField.bind(this));
            document.getElementById('quickAddClientBtn').addEventListener('click', this.showQuickAddClientModal.bind(this));
        },
        load() {
            Utils.populateSelect('pdvClient', state.clients, 'id', 'name', 'Selecione um cliente');
            this.renderProductList();
            this.clearSale();
        },
        showQuickAddClientModal() {
            const content = `
                <form id="quickClientForm">
                    <div class="form-group">
                        <label class="form-label" for="quickClientName">Nome Completo</label>
                        <input type="text" id="quickClientName" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="quickClientPhone">Telefone</label>
                        <input type="tel" id="quickClientPhone" class="form-input" placeholder="(00) 00000-0000">
                    </div>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Salvar Cliente</button>
                </form>
            `;
            Modal.show('Adicionar Novo Cliente', content);
            document.getElementById('quickClientForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('quickClientName').value.trim();
                const phone = document.getElementById('quickClientPhone').value.trim();
                if (!name) return Notification.error("O nome é obrigatório.");
                
                const btn = e.target.querySelector('button[type="submit"]');
                btn.disabled = true;

                try {
                    const { data: newClient, error } = await db.from('clients').insert({ name, phone }).select().single();
                    if (error) throw error;
                    
                    Notification.success("Cliente adicionado com sucesso!");
                    Modal.hide();
                    await App.loadAllData(false);
                    Utils.populateSelect('pdvClient', state.clients, 'id', 'name', 'Selecione um cliente');
                    document.getElementById('pdvClient').value = newClient.id;
                } catch (error) {
                    Notification.error("Erro ao salvar cliente: " + error.message);
                } finally {
                    btn.disabled = false;
                }
            });
        },
        toggleInstallmentsField() {
            const paymentMethod = document.getElementById('pdvPaymentMethod').value;
            const installmentsGroup = document.getElementById('pdvInstallmentsGroup');
            const installmentsSelect = document.getElementById('pdvInstallments');
            const showInstallments = ['Cartão de Crédito', 'Crediário'].includes(paymentMethod);

            installmentsGroup.classList.toggle('hidden', !showInstallments);

            if (showInstallments) {
                let options = '';
                const maxInstallments = paymentMethod === 'Crediário' ? 3 : 12;
                for (let i = 1; i <= maxInstallments; i++) {
                    options += `<option value="${i}">${i}x</option>`;
                }
                installmentsSelect.innerHTML = options;
            }
        },
        renderProductList() {
            const query = document.getElementById('pdvProductSearch').value.toLowerCase();
            const availableProducts = state.products.filter(p => p.quantity > 0 && (p.name.toLowerCase().includes(query) || p.ref_code.toLowerCase().includes(query)));
            const listEl = document.getElementById('pdvProductList');
            listEl.innerHTML = availableProducts.length > 0
                ? availableProducts.map(p => `<div class="product-item-pdv" onclick="App.modules.Sales.addToCart('${p.id}')">
                    <span>${p.name} (${p.ref_code})</span>
                    <strong>${Utils.formatCurrency(p.sale_price)}</strong>
                    </div>`).join('')
                : `<p class="text-center text-muted" style="padding: 20px;">Nenhum produto encontrado ou em estoque.</p>`;
        },
        addToCart(productId) {
            const product = state.products.find(p => p.id === productId);
            if (!product || product.quantity <= 0) {
                Notification.error("Este produto está esgotado e não pode ser vendido.");
                this.renderProductList();
                return;
            }
            const existingItem = state.cart.find(item => item.id === productId);
            if (existingItem) {
                if (existingItem.quantity < product.quantity) existingItem.quantity++;
                else Notification.warning(`Estoque máximo para ${product.name} atingido.`);
            } else {
                state.cart.push({ ...product, quantity: 1, stock_quantity: product.quantity });
            }
            this.renderCart();
        },
        removeFromCart(productId) {
            state.cart = state.cart.filter(item => item.id !== productId);
            this.renderCart();
        },
        updateCartQuantity(productId, newQuantity) {
            const item = state.cart.find(i => i.id === productId);
            newQuantity = parseInt(newQuantity);
            if (item && newQuantity > 0 && newQuantity <= item.stock_quantity) {
                item.quantity = newQuantity;
            } else if (item) {
                this.renderCart();
            }
        },
        renderCart() {
            const cartEl = document.getElementById('pdvCartItems');
            let total = 0;
            if (state.cart.length === 0) {
                cartEl.innerHTML = `<p class="text-center text-muted">Carrinho vazio</p>`;
            } else {
                cartEl.innerHTML = state.cart.map(item => {
                    total += item.sale_price * item.quantity;
                    return `<div class="cart-item">
                        <div>
                            <p style="font-size: 14px; margin-bottom: 5px;">${item.name}</p>
                            <input type="number" value="${item.quantity}" min="1" max="${item.stock_quantity}" onchange="App.modules.Sales.updateCartQuantity('${item.id}', this.value)" style="width: 60px; background: var(--primary-bg); border: 1px solid var(--border-color); color: white; border-radius: 4px; padding: 2px 5px;">
                        </div>
                        <div class="text-right">
                           <p>${Utils.formatCurrency(item.sale_price * item.quantity)}</p>
                           <button onclick="App.modules.Sales.removeFromCart('${item.id}')" style="background:none; border:none; color: var(--danger-color); cursor:pointer;"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </div>`;
                }).join('');
            }
            document.getElementById('pdvTotal').textContent = Utils.formatCurrency(total);
        },
        generateAndDownloadReceiptPDF(sale) {
            if (!sale) return;
            const client = state.clients.find(c => c.id === sale.client_id);
            const { company } = CONFIG;
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            doc.setFontSize(18);
            doc.text(company.name, 105, 20, { align: 'center' });
            doc.setFontSize(10);
            doc.text(company.address, 105, 26, { align: 'center' });
            doc.text(`CNPJ: ${company.cnpj} | Telefone: ${company.phone}`, 105, 32, { align: 'center' });
            doc.setFontSize(16);
            doc.text(`Recibo de Venda #${Utils.formatShortId(sale.id)}`, 105, 45, { align: 'center' });
            doc.setFontSize(12);
            doc.text(`Data: ${Utils.formatDate(sale.date)}`, 14, 55);
            doc.text(`Cliente: ${client?.name || 'Não identificado'}`, 14, 62);
            doc.text(`Telefone: ${client?.phone || 'N/A'}`, 14, 69);
            
            const head = [['Qtd', 'Produto', 'Preço Unit.', 'Subtotal']];
            const body = sale.items.map(item => [
                item.quantity,
                item.name,
                Utils.formatCurrency(item.price),
                Utils.formatCurrency(item.price * item.quantity)
            ]);
            
            doc.autoTable({ head, body, startY: 75, theme: 'striped' });

            const finalY = doc.lastAutoTable.finalY;
            doc.setFontSize(14);
            doc.text('Total:', 150, finalY + 10, { align: 'right' });
            doc.text(Utils.formatCurrency(sale.total), 200, finalY + 10, { align: 'right' });
            doc.text('Pagamento:', 150, finalY + 17, { align: 'right' });
            doc.text(sale.payment_method, 200, finalY + 17, { align: 'right' });

            doc.save(`recibo_${Utils.formatShortId(sale.id)}.pdf`);
        },
        showReceiptModal(sale) {
            const client = state.clients.find(c => c.id === sale.client_id);
            const company = CONFIG.company;

            const itemsHtml = sale.items.map(item => `
                <tr>
                    <td style="padding: 8px 0;">${item.quantity}x ${item.name}</td>
                    <td style="text-align: right; padding: 8px 0;">${Utils.formatCurrency(item.price * item.quantity)}</td>
                </tr>
            `).join('');
            
            const whatsappLink = (client && client.phone) 
                ? `https://wa.me/55${client.phone.replace(/\D/g, '')}?text=${encodeURIComponent(`Olá, ${client?.name}! Segue em anexo o recibo da sua compra.`)}`
                : '#';

            const modalContent = `
                <div id="receipt-content" style="background: var(--primary-bg); color: var(--text-primary); padding: 25px; border-radius: 8px; font-family: 'Segoe UI', sans-serif;">
                    <div style="text-align: center; border-bottom: 1px dashed var(--border-color); padding-bottom: 15px; margin-bottom: 20px;">
                        <h2 style="color: var(--primary-color); margin: 0; font-size: 24px; display: flex; align-items: center; justify-content: center; gap: 12px;">
                            <i class="fas fa-store"></i>
                            <span>${company.name}</span>
                        </h2>
                        <p style="font-size: 12px; color: var(--text-muted); margin: 5px 0 0;">${company.address}</p>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 20px; font-size: 14px;">
                        <div>
                            <strong>Cliente:</strong><br>
                            ${client?.name || 'N/A'}
                        </div>
                        <div style="text-align: right;">
                            <strong>Recibo Nº:</strong><br>
                            #${Utils.formatShortId(sale.id)}
                        </div>
                    </div>
                    <table style="width: 100%; margin-top: 10px; border-collapse: collapse; font-size: 14px;">
                        <thead>
                            <tr>
                                <th style="text-align: left; padding: 8px 0; border-bottom: 1px solid var(--border-color);">Item</th>
                                <th style="text-align: right; padding: 8px 0; border-bottom: 1px solid var(--border-color);">Subtotal</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsHtml}
                        </tbody>
                    </table>
                    <div style="margin-top: 20px; text-align: right;">
                        <div style="margin-bottom: 5px;">
                            <span style="color: var(--text-muted);">Pagamento:</span>
                            <span style="font-weight: 500;">${sale.payment_method}</span>
                        </div>
                        <div>
                            <span style="color: var(--text-muted); font-size: 18px;">Total:</span>
                            <span style="font-size: 22px; font-weight: bold; color: var(--accent-color);">${Utils.formatCurrency(sale.total)}</span>
                        </div>
                    </div>
                     <div style="text-align: center; margin-top: 30px; font-size: 14px; color: var(--text-muted);">
                        Obrigado pela sua compra!
                    </div>
                </div>
                <div class="modal-actions">
                     <button id="newSaleBtn" class="btn btn-secondary"><i class="fas fa-plus-circle"></i> Nova Venda</button>
                     <button id="downloadReceiptPdfBtn" class="btn btn-primary"><i class="fas fa-download"></i> Baixar PDF</button>
                     <a href="${whatsappLink}" target="_blank" class="btn btn-secondary ${(!client || !client.phone) ? 'disabled' : ''}" id="sendWhatsappBtn" style="background-color: #25D366; border-color: #25D366; color: white;">
                         <i class="fab fa-whatsapp"></i> Enviar via WhatsApp
                     </a>
                </div>
            `;

            Modal.show(`Venda #${Utils.formatShortId(sale.id)} Finalizada!`, modalContent);

            document.getElementById('newSaleBtn').addEventListener('click', () => {
                Modal.hide();
                App.loadAllData(false).then(() => this.load()); 
            });

            document.getElementById('downloadReceiptPdfBtn').addEventListener('click', () => {
                this.generateAndDownloadReceiptPDF(sale);
            });
            
            document.getElementById('sendWhatsappBtn').addEventListener('click', (e) => {
                if(e.currentTarget.classList.contains('disabled')) {
                    e.preventDefault();
                    Notification.warning('Cliente não possui telefone cadastrado para envio.');
                }
            });
        },
        async finalizeSale() {
            if (state.cart.length === 0) return Notification.warning('O carrinho está vazio.');
            
            const clientId = document.getElementById('pdvClient').value;
            if (!clientId) return Notification.error('Por favor, selecione um cliente.');

            const paymentMethod = document.getElementById('pdvPaymentMethod').value;
            const installmentsSelect = document.getElementById('pdvInstallments');
            const installments = ['Cartão de Crédito', 'Crediário'].includes(paymentMethod) ? parseInt(installmentsSelect.value) : 1;
            
            const btn = document.getElementById('finalizeSaleBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Finalizando...';

            const total = state.cart.reduce((sum, item) => sum + item.sale_price * item.quantity, 0);
            const paymentMethodDesc = installments > 1 ? `${paymentMethod} (${installments}x)` : paymentMethod;

            const saleData = {
                client_id: clientId,
                total: total,
                payment_method: paymentMethodDesc,
                items: state.cart.map(item => ({ id: item.id, name: item.name, quantity: item.quantity, price: item.sale_price })),
                date: new Date().toISOString()
            };

            try {
                const { data: newSale, error: saleError } = await db.from('sales').insert(saleData).select().single();
                if (saleError) throw saleError;
                
                for (const item of state.cart) {
                    const { error } = await db.rpc('decrement_product_quantity', { p_id: item.id, p_quantity: item.quantity });
                    if (error) throw new Error(`Erro ao atualizar estoque para ${item.name}: ${error.message}`);
                }
                
                const isImmediatePayment = ['Dinheiro', 'Pix', 'Cartão de Débito'].includes(paymentMethod) || (paymentMethod === 'Cartão de Crédito' && installments === 1);
                
                if (isImmediatePayment) {
                    await db.from('cash_flow').insert({
                        description: `Venda #${Utils.formatShortId(newSale.id)}`, value: total, type: 'entrada', date: new Date().toISOString()
                    });
                } else {
                    const installmentValue = parseFloat((total / installments).toFixed(2));
                    const receivablesToInsert = [];
                    for (let i = 1; i <= installments; i++) {
                        const dueDate = new Date();
                        dueDate.setMonth(dueDate.getMonth() + (i -1));
                        receivablesToInsert.push({
                            client_id: clientId,
                            sale_id: newSale.id,
                            value: installmentValue,
                            due_date: dueDate.toISOString(),
                            status: 'Pendente',
                            description: `Parcela ${i}/${installments} da Venda #${Utils.formatShortId(newSale.id)}`
                        });
                    }
                    const { error: receivablesError } = await db.from('receivables').insert(receivablesToInsert);
                    if(receivablesError) throw receivablesError;
                }
                
                Notification.success('Venda finalizada com sucesso!');
                this.showReceiptModal(newSale);

            } catch (error) {
                Notification.error(`Erro ao finalizar a venda: ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-check"></i> Finalizar Venda';
            }
        },
        clearSale() {
            state.cart = [];
            this.renderCart();
            document.getElementById('pdvProductSearch').value = '';
            document.getElementById('pdvClient').value = '';
            document.getElementById('pdvPaymentMethod').value = 'Dinheiro';
            this.toggleInstallmentsField();
        }
    };
    
	App.modules.Receipts = {
        pageId: 'receipts',
        init() {
            document.getElementById('receiptsFilterBtn').addEventListener('click', () => this.render());
            document.getElementById('receiptsClearBtn').addEventListener('click', () => {
                document.getElementById('receiptsStartDate').value = '';
                document.getElementById('receiptsEndDate').value = '';
                this.render();
            });
        },
        load() { this.render(); },
        render() {
            const tableBody = document.getElementById('receiptsTableBody');
            const startDate = document.getElementById('receiptsStartDate').value;
            const endDate = document.getElementById('receiptsEndDate').value;

            let sales = [...state.sales];

            if (startDate && endDate) {
                sales = sales.filter(s => {
                    const saleDate = s.date.split('T')[0];
                    return saleDate >= startDate && saleDate <= endDate;
                });
            }

            sales.sort((a,b) => new Date(b.date) - new Date(a.date));

            if(sales.length === 0){
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center" style="padding: 20px;">Nenhuma venda encontrada.</td></tr>`;
                return;
            }
            tableBody.innerHTML = sales.map(sale => {
                const client = state.clients.find(c => c.id === sale.client_id)?.name || 'Cliente Avulso';
                return `<tr>
                    <td data-label="Recibo">#${Utils.formatShortId(sale.id)}</td>
                    <td data-label="Data">${Utils.formatDate(sale.date)}</td>
                    <td data-label="Cliente">${client}</td>
                    <td data-label="Total">${Utils.formatCurrency(sale.total)}</td>
                    <td data-label="Pagamento"><span class="badge badge-info">${sale.payment_method}</span></td>
                    <td data-label="Ações"><div class="table-actions">
                        <button class="btn btn-secondary btn-sm" onclick="App.modules.Receipts.viewDetails('${sale.id}')"><i class="fas fa-eye"></i></button>
                        <button class="btn btn-primary btn-sm" onclick="App.modules.Receipts.printReceipt('${sale.id}')"><i class="fas fa-print"></i></button>
                    </div></td>
                </tr>`;
            }).join('');
        },
        viewDetails(saleId) {
            const sale = state.sales.find(s => s.id == saleId);
            if (!sale) return;
            App.modules.Sales.showReceiptModal(sale);
        },
        printReceipt(saleId) {
            const sale = state.sales.find(s => s.id == saleId);
            if (!sale) return;
            App.modules.Sales.generateAndDownloadReceiptPDF(sale);
        }
    };

    App.modules.CashFlow = {
        pageId: 'cashflow',
        init() {
            document.getElementById('cashflowFilterBtn').addEventListener('click', () => this.render());
            document.getElementById('cashflowClearBtn').addEventListener('click', () => {
                document.getElementById('cashflowStartDate').value = '';
                document.getElementById('cashflowEndDate').value = '';
                this.render();
            });
        },
        load() { this.render(); },
        render() {
            const tableBody = document.getElementById('cashflowTableBody');
            const startDate = document.getElementById('cashflowStartDate').value;
            const endDate = document.getElementById('cashflowEndDate').value;

            let flow = [...state.cashFlow];

            if(startDate && endDate) {
                flow = flow.filter(f => {
                    const flowDate = f.date.split('T')[0];
                    return flowDate >= startDate && flowDate <= endDate;
                });
            }
            
            flow.sort((a,b) => new Date(b.date) - new Date(a.date));

            if(flow.length === 0){
                tableBody.innerHTML = `<tr><td colspan="4" class="text-center" style="padding: 20px;">Nenhum lançamento no caixa.</td></tr>`;
                return;
            }
            tableBody.innerHTML = flow.map(item => `
                <tr>
                    <td data-label="Data">${Utils.formatDate(item.date)}</td>
                    <td data-label="Descrição">${item.description}</td>
                    <td data-label="Tipo">${item.type === 'entrada' ? `<span class="badge badge-success">Entrada</span>` : `<span class="badge badge-danger">Saída</span>`}</td>
                    <td data-label="Valor" style="color: ${item.type === 'entrada' ? 'var(--accent-color)' : 'var(--danger-color)'}; font-weight: bold;">
                        ${Utils.formatCurrency(item.value)}
                    </td>
                </tr>
            `).join('');
        }
    };
    
    App.modules.Expenses = {
        pageId: 'expenses',
        init() {
            document.getElementById('expenseForm').addEventListener('submit', this.save.bind(this));
            document.getElementById('expensesFilterBtn').addEventListener('click', () => this.render());
            document.getElementById('expensesClearBtn').addEventListener('click', () => {
                document.getElementById('expensesStartDate').value = '';
                document.getElementById('expensesEndDate').value = '';
                this.render();
            });
        },
        load() { this.render(); },
        render() {
            const tableBody = document.getElementById('expensesTableBody');
            const startDate = document.getElementById('expensesStartDate').value;
            const endDate = document.getElementById('expensesEndDate').value;

            let expenses = [...state.expenses];

            if(startDate && endDate) {
                expenses = expenses.filter(e => {
                    const expenseDate = e.date.split('T')[0];
                    return expenseDate >= startDate && expenseDate <= endDate;
                });
            }

            expenses.sort((a,b) => new Date(b.date) - new Date(a.date));

            if(expenses.length === 0){
                tableBody.innerHTML = `<tr><td colspan="4" class="text-center" style="padding: 20px;">Nenhuma despesa registrada.</td></tr>`;
                return;
            }
            tableBody.innerHTML = expenses.map(e => `
                <tr>
                    <td data-label="Data">${Utils.formatDate(e.date)}</td>
                    <td data-label="Descrição">${e.description}</td>
                    <td data-label="Valor" style="font-weight: bold;">${Utils.formatCurrency(e.value)}</td>
                    <td data-label="Ações"><div class="table-actions">
                        <button class="btn btn-danger btn-sm" onclick="App.modules.Expenses.remove('${e.id}')"><i class="fas fa-trash"></i></button>
                    </div></td>
                </tr>
            `).join('');
        },
        async save(e) {
            e.preventDefault();
            const formData = {
                description: document.getElementById('expenseDescription').value,
                value: parseFloat(document.getElementById('expenseValue').value),
                date: document.getElementById('expenseDate').value,
            };
            if(!formData.description || isNaN(formData.value) || !formData.date) {
                return Notification.error('Preencha todos os campos da despesa.');
            }
            
            const btn = e.target.querySelector('button[type="submit"]');
            btn.disabled = true;

            try {
                const { data: newExpense, error: expenseError } = await db.from('expenses').insert(formData).select().single();
                if (expenseError) throw expenseError;
                
                await db.from('cash_flow').insert({
                    description: `Despesa: ${formData.description}`,
                    value: formData.value,
                    type: 'saida',
                    date: formData.date
                });

                Notification.success('Despesa registrada com sucesso!');
                e.target.reset();
                await Navigation.navigateTo('expenses');

            } catch(error) {
                Notification.error('Erro ao salvar despesa: ' + error.message);
            } finally {
                btn.disabled = false;
            }
        },
        async remove(id) {
            if(!confirm('Deseja realmente excluir esta despesa? Esta ação é irreversível.')) return;
            try {
                const { error } = await db.from('expenses').delete().eq('id', id);
                if (error) throw error;
                Notification.success('Despesa excluída.');
                await Navigation.navigateTo('expenses');
            } catch(error) {
                console.error('Erro ao excluir despesa:', error);
                Notification.error('Erro ao excluir despesa: ' + error.message);
            }
        }
    };
    
    App.modules.Receivables = {
        pageId: 'receivables',
        load() { this.render(); },
        render() {
            const tableBody = document.getElementById('receivablesTableBody');
            const receivables = [...state.receivables].filter(r => r.status !== 'Pago').sort((a,b) => new Date(a.due_date) - new Date(b.due_date));
            if(receivables.length === 0){
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center" style="padding: 20px;">Nenhuma conta a receber.</td></tr>`;
                return;
            }
            const today = new Date().toISOString().split('T')[0];
            tableBody.innerHTML = receivables.map(r => {
                const client = state.clients.find(c => c.id === r.client_id)?.name || 'N/A';
                const sale = state.sales.find(s => s.id === r.sale_id);
                let statusBadge;
                if (r.due_date < today) {
                    statusBadge = `<span class="badge badge-danger">Vencido</span>`;
                } else {
                    statusBadge = `<span class="badge badge-warning">Pendente</span>`;
                }
                return `<tr>
                    <td data-label="Cliente">${client}</td>
                    <td data-label="Valor">${Utils.formatCurrency(r.value)}</td>
                    <td data-label="Data Venda">${Utils.formatDate(sale?.date)}</td>
                    <td data-label="Vencimento">${Utils.formatDate(r.due_date)}</td>
                    <td data-label="Status">${statusBadge}</td>
                    <td data-label="Ações"><div class="table-actions">
                        <button class="btn btn-accent btn-sm" onclick="App.modules.Receivables.markAsPaid('${r.id}')"><i class="fas fa-check-circle"></i> Marcar como Pago</button>
                    </div></td>
                </tr>`;
            }).join('');
        },
        async markAsPaid(id) {
            if(!confirm('Confirmar o recebimento desta conta?')) return;
            const receivable = state.receivables.find(r => r.id == id);
            if(!receivable) return;

            try {
                await db.from('receivables').update({ status: 'Pago', paid_at: new Date().toISOString() }).eq('id', id);

                await db.from('cash_flow').insert({
                    description: receivable.description || `Recebimento da venda #${Utils.formatShortId(receivable.sale_id)}`,
                    value: receivable.value,
                    type: 'entrada',
                    date: new Date().toISOString()
                });
                
                Notification.success('Conta marcada como paga!');
                await Navigation.navigateTo('receivables');
            } catch(error) {
                Notification.error('Erro ao processar pagamento: ' + error.message);
            }
        }
    };
    
    App.modules.Reports = {
        pageId: 'reports',
        init() {
            document.getElementById('generateSalesReportBtn').addEventListener('click', () => this.showDateRangeModal('sales'));
            document.getElementById('generateTopProductsReportBtn').addEventListener('click', () => this.showDateRangeModal('topProducts'));
            document.getElementById('generateClientSalesReportBtn').addEventListener('click', () => this.showClientSelectModal('clientSales'));
            document.getElementById('generateClientReceivablesReportBtn').addEventListener('click', () => this.showClientSelectModal('clientReceivables'));
        },
        load() {
            this.clearReportOutput();
        },
        clearReportOutput() {
             document.getElementById('reportOutputHeader').innerHTML = `<h3 class="card-title"><i class="fas fa-chart-pie"></i> Visualização de Relatório</h3>`;
             document.getElementById('reportOutput').innerHTML = `<p class="text-center" style="color: var(--text-muted); padding: 20px;">Selecione um relatório para visualizar os dados aqui.</p>`;
        },
        addPdfButton(reportTitle, pdfHead, pdfBody, extraContent = null) {
            const header = document.getElementById('reportOutputHeader');
            header.innerHTML = `
                <h3 class="card-title"><i class="fas fa-chart-pie"></i> ${reportTitle}</h3>
                <button id="exportReportPdf" class="btn btn-secondary btn-sm"><i class="fas fa-file-pdf"></i> Baixar PDF</button>
            `;
            document.getElementById('exportReportPdf').onclick = () => {
                Utils.exportToPDF(reportTitle, pdfHead, pdfBody, extraContent);
            };
        },
        showDateRangeModal(reportType) {
            const content = `
                <div class="grid grid-2">
                    <div class="form-group">
                        <label class="form-label" for="reportStartDate">Data de Início</label>
                        <input type="date" id="reportStartDate" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="reportEndDate">Data de Fim</label>
                        <input type="date" id="reportEndDate" class="form-input" required>
                    </div>
                </div>
                <button id="runReportBtn" class="btn btn-primary mt-4">Gerar Relatório</button>
            `;
            Modal.show('Selecione o Período', content);
            document.getElementById('runReportBtn').onclick = () => {
                const start = document.getElementById('reportStartDate').value;
                const end = document.getElementById('reportEndDate').value;
                if (!start || !end) return Notification.error('Selecione as datas de início e fim.');
                if (reportType === 'sales') this.generateSalesReport(start, end);
                if (reportType === 'topProducts') this.generateTopProductsReport(start, end);
                Modal.hide();
            };
        },
        showClientSelectModal(reportType) {
            let options = state.clients.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            const content = `
                <div class="form-group">
                    <label class="form-label" for="reportClientSelect">Selecione o Cliente</label>
                    <select id="reportClientSelect" class="form-select">${options}</select>
                </div>
                <button id="runClientReportBtn" class="btn btn-primary mt-4">Gerar Relatório</button>
            `;
            Modal.show('Selecione o Cliente', content);
            document.getElementById('runClientReportBtn').onclick = () => {
                const clientId = document.getElementById('reportClientSelect').value;
                if (!clientId) return Notification.error('Selecione um cliente.');
                if (reportType === 'clientSales') this.generateClientSalesReport(clientId);
                if (reportType === 'clientReceivables') this.generateClientReceivablesReport(clientId);
                Modal.hide();
            }
        },
        generateSalesReport(start, end) {
            const sales = state.sales.filter(s => s.date >= start && s.date <= end + 'T23:59:59');
            const reportTitle = `Relatório de Vendas`;
            const reportSubtitle = `Período: ${Utils.formatDate(start)} a ${Utils.formatDate(end)}`;

            if (sales.length === 0) {
                document.getElementById('reportOutput').innerHTML = '<p class="text-center text-muted">Nenhuma venda encontrada no período.</p>';
                return;
            }
            const total = sales.reduce((sum, s) => sum + s.total, 0);
            
            let html = `
                <p><strong>Total de Vendas:</strong> ${sales.length}</p>
                <p><strong>Faturamento Total:</strong> ${Utils.formatCurrency(total)}</p>
                <canvas id="salesReportChart" style="margin-top:20px; max-height: 300px;"></canvas>
            `;
            document.getElementById('reportOutput').innerHTML = html;
            
            const salesByDay = sales.reduce((acc, sale) => {
                const date = Utils.formatDate(sale.date);
                acc[date] = (acc[date] || 0) + sale.total;
                return acc;
            }, {});

            Utils.renderChart('salesReportChart', 'line', {
                labels: Object.keys(salesByDay),
                datasets: [{
                    label: 'Faturamento Diário',
                    data: Object.values(salesByDay),
                    borderColor: 'var(--primary-color)', backgroundColor: 'rgba(var(--primary-color-rgb), 0.2)',
                    fill: true, tension: 0.3
                }]
            }, { responsive: true, maintainAspectRatio: false, scales: { y: { ticks: { color: 'var(--text-secondary)' } }, x: { ticks: { color: 'var(--text-secondary)' } } } });

            const pdfHead = [['Recibo', 'Data', 'Cliente', 'Total', 'Pagamento']];
            const pdfBody = sales.map(s => [Utils.formatShortId(s.id), Utils.formatDate(s.date), state.clients.find(c => c.id === s.client_id)?.name || 'N/A', Utils.formatCurrency(s.total), s.payment_method]);
            this.addPdfButton(reportTitle, pdfHead, pdfBody, [reportSubtitle, `Faturamento Total: ${Utils.formatCurrency(total)}`]);
        },
        generateTopProductsReport(start, end) {
            const salesInPeriod = state.sales.filter(s => s.date >= start && s.date <= end + 'T23:59:59');
            const reportTitle = 'Produtos Mais Vendidos';
            const reportSubtitle = `Período: ${Utils.formatDate(start)} a ${Utils.formatDate(end)}`;
            
            const productCount = salesInPeriod.flatMap(s => s.items).reduce((acc, item) => {
                acc[item.name] = (acc[item.name] || 0) + item.quantity;
                return acc;
            }, {});

            const sortedProducts = Object.entries(productCount).sort(([,a],[,b]) => b-a).slice(0, 10);
            if (sortedProducts.length === 0) {
                document.getElementById('reportOutput').innerHTML = '<p class="text-center text-muted">Nenhum produto vendido no período.</p>';
                return;
            }
            let html = `<canvas id="topProductsChart" style="margin-top:20px; max-height: 300px;"></canvas>`;
            document.getElementById('reportOutput').innerHTML = html;

             Utils.renderChart('topProductsChart', 'bar', {
                labels: sortedProducts.map(p => p[0]),
                datasets: [{
                    label: 'Quantidade Vendida', data: sortedProducts.map(p => p[1]), backgroundColor: 'rgba(var(--primary-color-rgb), 0.7)',
                }]
            }, { responsive: true, maintainAspectRatio: false, indexAxis: 'y', scales: { y: { ticks: { color: 'var(--text-secondary)' } }, x: { ticks: { color: 'var(--text-secondary)' } } } });

            const pdfHead = [['Produto', 'Quantidade Vendida']];
            const pdfBody = sortedProducts.map(p => [p[0], p[1]]);
            this.addPdfButton(reportTitle, pdfHead, pdfBody, [reportSubtitle]);
        },
        generateClientSalesReport(clientId) {
            const client = state.clients.find(c => c.id == clientId);
            const sales = state.sales.filter(s => s.client_id == clientId).sort((a,b) => new Date(b.date) - new Date(a.date));
            const reportTitle = `Compras de ${client.name}`;

            if (sales.length === 0) {
                 document.getElementById('reportOutput').innerHTML = `<p class="text-center text-muted">Nenhuma compra encontrada para ${client.name}.</p>`;
                return;
            }
            const totalSpent = sales.reduce((sum, s) => sum + s.total, 0);
            let html = `
                <p><strong>Total de Compras:</strong> ${sales.length}</p>
                <p><strong>Valor Total Gasto:</strong> ${Utils.formatCurrency(totalSpent)}</p>
                <div class="table-responsive mt-4"><table class="table">
                <thead><tr><th>Data</th><th>Total</th><th>Pagamento</th></tr></thead>
                <tbody>${sales.map(s => `<tr><td>${Utils.formatDate(s.date)}</td><td>${Utils.formatCurrency(s.total)}</td><td>${s.payment_method}</td></tr>`).join('')}</tbody>
                </table></div>`;
            document.getElementById('reportOutput').innerHTML = html;

            const pdfHead = [['Data', 'Total', 'Pagamento']];
            const pdfBody = sales.map(s => [Utils.formatDate(s.date), Utils.formatCurrency(s.total), s.payment_method]);
            this.addPdfButton(reportTitle, pdfHead, pdfBody, [`Valor Total Gasto: ${Utils.formatCurrency(totalSpent)}`]);
        },
        generateClientReceivablesReport(clientId) {
            const client = state.clients.find(c => c.id == clientId);
            const clientReceivables = state.receivables.filter(r => r.client_id == clientId);
            const reportTitle = `Análise de Contas de ${client.name}`;
            
            const paid = clientReceivables.filter(r => r.status === 'Pago');
            const unpaid = clientReceivables.filter(r => r.status !== 'Pago');
            const totalPaid = paid.reduce((sum, r) => sum + r.value, 0);
            const totalOwed = unpaid.reduce((sum, r) => sum + r.value, 0);

            let html = `
                <div class="grid grid-2">
                    <div class="stat-card"><div class="stat-value" style="color:var(--accent-color)">${Utils.formatCurrency(totalPaid)}</div><div class="stat-label">Total Pago</div></div>
                    <div class="stat-card"><div class="stat-value" style="color:var(--danger-color)">${Utils.formatCurrency(totalOwed)}</div><div class="stat-label">Total a Pagar</div></div>
                </div>
                <h4 class="mt-4">Contas Pendentes/Vencidas (${unpaid.length})</h4>
                <div class="table-responsive mt-4"><table class="table">
                    <thead><tr><th>Descrição</th><th>Vencimento</th><th>Valor</th></tr></thead>
                    <tbody>${unpaid.length > 0 ? unpaid.map(r => `<tr><td>${r.description}</td><td>${Utils.formatDate(r.due_date)}</td><td>${Utils.formatCurrency(r.value)}</td></tr>`).join('') : '<tr><td colspan=3 class=text-center>Nenhuma conta pendente.</td></tr>'}</tbody>
                </table></div>
                <h4 class="mt-4">Contas Pagas (${paid.length})</h4>
                <div class="table-responsive mt-4"><table class="table">
                    <thead><tr><th>Descrição</th><th>Data Pgto.</th><th>Valor</th></tr></thead>
                    <tbody>${paid.length > 0 ? paid.map(r => `<tr><td>${r.description}</td><td>${Utils.formatDate(r.paid_at)}</td><td>${Utils.formatCurrency(r.value)}</td></tr>`).join('') : '<tr><td colspan=3 class=text-center>Nenhuma conta paga.</td></tr>'}</tbody>
                </table></div>
            `;
            document.getElementById('reportOutput').innerHTML = html;
            
            const pdfHead = [['Descrição', 'Vencimento', 'Status', 'Valor']];
            const pdfBody = unpaid.map(r => [r.description, Utils.formatDate(r.due_date), r.due_date < new Date().toISOString().split('T')[0] ? 'Vencido' : 'Pendente', Utils.formatCurrency(r.value)]);
            this.addPdfButton(reportTitle, pdfHead, pdfBody, [`Total Pago: ${Utils.formatCurrency(totalPaid)}`, `Total a Pagar: ${Utils.formatCurrency(totalOwed)}`]);
        }
    };

    App.modules.Settings = {
        pageId: 'settings',
        init() {
            document.getElementById('settingsForm').addEventListener('submit', this.save.bind(this));
            document.getElementById('resetFinancialDataBtn').addEventListener('click', this.handleResetFinancialData);
            document.getElementById('clearClientsBtn').addEventListener('click', () => this.handleClearTable('clients', 'clientes', 'LIMPAR CLIENTES'));
            document.getElementById('clearProductsBtn').addEventListener('click', () => this.handleClearTable('products', 'produtos', 'LIMPAR PRODUTOS'));
        },
        load() {
            this.loadCompanyInfo();
            const { name, cnpj, address, phone } = CONFIG.company;
            document.getElementById('companyName').value = name;
            document.getElementById('companyCnpj').value = cnpj;
            document.getElementById('companyAddress').value = address;
            document.getElementById('companyPhone').value = phone;
        },
        loadCompanyInfo() {
            const storedInfo = localStorage.getItem(CONFIG.storageKeys.companyInfo);
            if(storedInfo) {
                CONFIG.company = JSON.parse(storedInfo);
            }
        },
        save(e) {
            e.preventDefault();
            const newConfig = {
                name: document.getElementById('companyName').value,
                cnpj: document.getElementById('companyCnpj').value,
                address: document.getElementById('companyAddress').value,
                phone: document.getElementById('companyPhone').value,
            };
            CONFIG.company = newConfig;
            localStorage.setItem(CONFIG.storageKeys.companyInfo, JSON.stringify(newConfig));
            Notification.success('Configurações salvas com sucesso!');
        },
        async handleResetFinancialData() {
            const confirmation = prompt('Atenção! Esta ação é irreversível e irá apagar TODOS os dados de vendas, fluxo de caixa, despesas e contas a receber.\n\nPara confirmar, digite ZERAR DADOS em maiúsculas.');
            if (confirmation !== 'ZERAR DADOS') {
                return Notification.warning('Ação cancelada.');
            }
            try {
                document.body.className = 'state-loading';
                const tablesToClear = ['sales', 'cash_flow', 'expenses', 'receivables'];
                const promises = tablesToClear.map(tableName => db.from(tableName).delete().neq('id', '00000000-0000-0000-0000-000000000000'));
                await Promise.all(promises);
                
                Notification.success('Todos os dados financeiros foram zerados com sucesso!');
                await Navigation.navigateTo('dashboard');

            } catch (error) {
                console.error('Erro ao zerar dados financeiros:', error);
                Notification.error('Ocorreu um erro ao zerar os dados: ' + error.message);
                document.body.className = 'state-app';
            }
        },
        async handleClearTable(tableName, displayName, confirmationKeyword) {
            const confirmation = prompt(`Atenção! Esta ação é irreversível e irá apagar TODOS os ${displayName} cadastrados.\n\nPara confirmar, digite ${confirmationKeyword} em maiúsculas.`);
            if (confirmation !== confirmationKeyword) {
                return Notification.warning('Ação cancelada.');
            }
            try {
                document.body.className = 'state-loading';
                await db.from(tableName).delete().neq('id', '00000000-0000-0000-0000-000000000000');
                Notification.success(`Todos os ${displayName} foram excluídos.`);
                await Navigation.navigateTo('dashboard');
            } catch (error) {
                console.error(`Erro ao limpar ${displayName}:`, error);
                Notification.error(`Ocorreu um erro ao limpar os ${displayName}: ` + error.message);
                document.body.className = 'state-app';
            }
        }
    };

    document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>
</html>
