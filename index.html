label, labels, data) {
        const ctx = document.getElementById('reportChart').getContext('2d');
        if (this.chart) this.chart.destroy();
        this.chart = new Chart(ctx, {
            type: 'line',
            data: { labels, datasets: [{ label, data, borderColor: '#3B82F6', tension: 0.1 }] },
            options: { ...Dashboard.chart.options } // Reuse dashboard chart options
        });
    },
    updateTopLists(type, data) {
        const container = document.getElementById('topProductsList');
        let content = '';
        switch(type) {
            case 'produtos':
                 const productSales = {};
                 data.forEach(sale => sale.items.forEach(item => {
                    productSales[item.id] = (productSales[item.id] || 0) + item.quantity;
                 }));
                 const topProducts = Object.keys(productSales).sort((a,b) => productSales[b] - productSales[a]).slice(0,5);
                 content = `<h6>Top 5 Produtos Mais Vendidos</h6><ol>${topProducts.map(id => `<li>${(data.flatMap(s=>s.items).find(i=>i.id===id)).name} (${productSales[id]} un)</li>`).join('')}</ol>`;
                break;
            case 'produtos_report':
                 content = `<h6>Top 5 Produtos (Receita)</h6><ol>${data.slice(0,5).map(p => `<li>${p.name} (${Utils.formatCurrency(p.revenue)})</li>`).join('')}</ol>`;
                break;
             case 'clientes_report':
                 content = `<h6>Top 5 Clientes (Gastos)</h6><ol>${data.slice(0,5).map(p => `<li>${p.name} (${Utils.formatCurrency(p.total)})</li>`).join('')}</ol>`;
                break;
             case 'devedores_report':
                 content = `<h6>Top 5 Devedores</h6><ol>${data.slice(0,5).map(p => `<li>${p.name} (${Utils.formatCurrency(p.debt)})</li>`).join('')}</ol>`;
                break;
            case 'despesas':
                const expenseCats = {};
                data.filter(i => i.type === 'saida').forEach(i => {
                    const desc = i.description.split(':')[0]; // e.g., "Despesa"
                    expenseCats[desc] = (expenseCats[desc] || 0) + i.value;
                });
                const topCats = Object.keys(expenseCats).sort((a,b) => expenseCats[b] - expenseCats[a]).slice(0,5);
                content = `<h6>Top 5 Categorias de Despesa</h6><ol>${topCats.map(cat => `<li>${cat} (${Utils.formatCurrency(expenseCats[cat])})</li>`).join('')}</ol>`;
                break;
        }
        container.innerHTML = content || '<p class="text-center" style="color: var(--text-muted); padding: 20px;">Sem dados para exibir.</p>';
    },
    renderDetailTable(data) {
        const thead = document.getElementById('reportTableHead');
        const tbody = document.getElementById('reportTableBody');
        if (data.length === 0) {
            thead.innerHTML = '';
            tbody.innerHTML = `<tr><td class="text-center" style="padding: 40px;">Nenhum dado para este relatório.</td></tr>`;
            return;
        }
        const headers = Object.keys(data[0]);
        thead.innerHTML = `<tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;
        tbody.innerHTML = data.map(row => `<tr>${headers.map(h => `<td>${row[h]}</td>`).join('')}</tr>`).join('');
    },
    exportToPDF() {
        if (this.reportData.length === 0) return Notification.warning('Gere um relatório primeiro.');
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text(`Relatório - ${document.getElementById('reportType').value}`, 14, 16);
        doc.autoTable({
            head: [Object.keys(this.reportData[0])],
            body: this.reportData.map(row => Object.values(row)),
            startY: 20,
        });
        doc.save(`relatorio_${new Date().toISOString().split('T')[0]}.pdf`);
    },
    exportToCSV() {
        if (this.reportData.length === 0) return Notification.warning('Gere um relatório primeiro.');
        const headers = Object.keys(this.reportData[0]);
        const csvContent = [
            headers.join(','),
            ...this.reportData.map(row => headers.map(h => `"${row[h]}"`).join(','))
        ].join('\n');
        Utils.downloadCSV(csvContent, `relatorio_${document.getElementById('reportType').value}`);
    }
};

// Módulo de Configurações
const Settings = {
    init() {
        document.getElementById('downloadBackup').addEventListener('click', () => this.downloadBackup());
        document.getElementById('restoreFile').addEventListener('change', (e) => {
            document.getElementById('restoreBackup').disabled = !e.target.files.length;
        });
        document.getElementById('restoreBackup').addEventListener('click', () => this.restoreBackup());
        document.getElementById('clearAllData').addEventListener('click', () => this.clearAllData());
    },
    async updateBackupStats() {
        const counts = await Promise.all([
            db.collection(CONFIG.storageKeys.clients).get().then(snap => snap.size),
            db.collection(CONFIG.storageKeys.products).get().then(snap => snap.size),
            db.collection(CONFIG.storageKeys.sales).get().then(snap => snap.size),
            db.collection(CONFIG.storageKeys.accountsReceivable).get().then(snap => snap.size),
        ]);
        document.getElementById('backupClientsCount').textContent = counts[0];
        document.getElementById('backupProductsCount').textContent = counts[1];
        document.getElementById('backupSalesCount').textContent = counts[2];
        document.getElementById('backupReceivablesCount').textContent = counts[3];
    },
    async downloadBackup() {
        Notification.show("Iniciando backup completo...", "warning");
        const backupData = {};
        for (const key in CONFIG.storageKeys) {
            if(key === 'lastActivePage') continue;
            const collectionName = CONFIG.storageKeys[key];
            backupData[collectionName] = await Utils.loadFromStorage(collectionName);
        }
        const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `backup_sgi_${new Date().toISOString()}.json`;
        link.click();
        Notification.success("Backup baixado com sucesso!");
    },
    async restoreBackup() {
        const file = document.getElementById('restoreFile').files[0];
        if (!file) return Notification.error('Selecione um arquivo de backup.');
        if (!confirm('ATENÇÃO! Restaurar um backup substituirá TODOS os dados atuais. Esta ação é IRREVERSÍVEL. Deseja continuar?')) return;

        Notification.show("Restaurando backup... Por favor, aguarde.", "warning");
        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const backupData = JSON.parse(e.target.result);
                // First, clear all existing data
                await this.clearAllData(false); // false to skip confirmation
                
                // Then, restore from backup file
                const promises = [];
                for (const collectionName in backupData) {
                    const collectionData = backupData[collectionName];
                    if(Array.isArray(collectionData)) {
                        const batch = db.batch();
                        collectionData.forEach(item => {
                            if(item.id) {
                                const docRef = db.collection(collectionName).doc(item.id);
                                batch.set(docRef, item);
                            }
                        });
                        promises.push(batch.commit());
                    }
                }
                await Promise.all(promises);
                Notification.success("Backup restaurado com sucesso! A página será recarregada.");
                setTimeout(() => window.location.reload(), 2000);
            } catch (error) {
                console.error("Erro ao restaurar backup:", error);
                Notification.error("Erro no arquivo de backup ou ao restaurar os dados.");
            }
        };
        reader.readAsText(file);
    },
    async clearAllData(confirmFirst = true) {
        if (confirmFirst && !confirm('PERIGO! Esta ação apagará TODOS os dados do sistema (clientes, produtos, vendas, etc.). É IRREVERSÍVEL. Tem certeza ABSOLUTA?')) return;

        Notification.show("Limpando todos os dados...", "warning");
        try {
            const promises = [];
            for (const key in CONFIG.storageKeys) {
                if (key === 'lastActivePage') continue;
                const collectionName = CONFIG.storageKeys[key];
                const promise = db.collection(collectionName).get().then(snapshot => {
                    const batch = db.batch();
                    snapshot.docs.forEach(doc => batch.delete(doc.ref));
                    return batch.commit();
                });
                promises.push(promise);
            }
            await Promise.all(promises);
            Notification.success("Todos os dados foram limpos com sucesso.");
            await this.updateBackupStats();
        } catch (error) {
            console.error("Erro ao limpar dados:", error);
            Notification.error("Ocorreu um erro ao limpar os dados.");
        }
    }
};

// Inicialização do Sistema
document.addEventListener('DOMContentLoaded', () => {
    Auth.init();
    Navigation.init();
    Clients.init();
    Products.init();
    Sales.init();
    Receipts.init();
    CashFlow.init();
    Expenses.init();
    Receivables.init();
    Reports.init();
    Settings.init();

    document.getElementById('modalClose').addEventListener('click', () => Modal.hide());
    document.getElementById('modal').addEventListener('click', (e) => {
        if (e.target.id === 'modal') Modal.hide();
    });

    console.log('SGI - Flor de Maria v3.0 (Firebase) iniciado!');
});
</body>
</html>
